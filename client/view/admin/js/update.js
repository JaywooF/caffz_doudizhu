var lib={load:0,check:function(_path,_token){this.load=layer.load(1);$.post(_path+"index.php/admin/update/check",{token:_token},function(data){layer.close(lib.load);var obj=JSON.parse(data);if(obj.state==1){$("th").css({color:"#d9534f",padding:"30px"}).html(obj.msg);$("button").attr("onclick","lib.down('"+_path+"', '"+_token+"', 'get', 0)").text("下载更新")}else if(obj.state==-1){layer.msg("已是最新版！",{icon:1})}else if(obj.state==-2){layer.msg("服务器繁忙！",{icon:3})}else if(obj.state==-3){layer.msg("登录已超时！",{icon:4})}else if(obj.state==-4){layer.msg("权限或进程出错！",{icon:2})}else{layer.msg(obj.state,{time:0,btn:["确定"]})}})},done:function(_path,_token){$("td i").text(" 正在更新数据...");$.post(_path+"index.php/admin/update/done",{token:_token},function(data){if(data==1){$("td i").text(" 更新成功，请稍等...");setTimeout("location.reload()",1e3)}else if(data==-1){layer.msg("登录已超时！",{icon:4})}else if(data==-2){layer.msg("服务器繁忙！",{icon:3})}else if(data==-3){layer.msg("权限或进程出错！",{icon:2})}else{layer.msg(data,{time:0,btn:["确定"]})}})},plant:function(_path,_token){$("td i").text(" 正在更新文件...");$.post(_path+"index.php/admin/update/plant",{token:_token},function(data){if(data==1){lib.done(_path,_token)}else if(data==-1){layer.msg("登录已超时！",{icon:4})}else{layer.msg(data,{time:0,btn:["确定"]})}})},flush:function(_path,_token,_size){$.post(_path+"index.php/admin/update/flush",{token:_token},function(data){var obj=JSON.parse(data);if(isNaN(obj.state)){layer.msg(obj.state,{time:0,btn:["确定"]})}else if(obj.state==-1){layer.msg("登录已超时！",{icon:4})}else{if($("td i").hasClass("fa-download")){if(_size>0&&obj.state>0){var percent=Math.round(obj.state*100/_size)+"%";$("td").parent().css("background-size",percent);$("td i").text(" 已下载 "+percent)}else{$("td i").text(" 已下载 "+obj.msg)}lib.flush(_path,_token,_size)}}})},down:function(_path,_token,_type,_size){if(_type=="get"){this.load=layer.load(1)}else{this.flush(_path,_token,_size)}$.post(_path+"index.php/admin/update/down/"+_type,{token:_token},function(data){if(_type=="get"){layer.close(lib.load)}else{$("td").parent().css("background-size","100%");$("td i").removeClass("fa-download").addClass("fa-spinner")}if(isNaN(data)){if(data=="logout"){layer.msg("登录已超时！",{icon:4})}else if(data=="busy"){layer.msg("服务器繁忙！",{icon:3})}else if(data=="io"){layer.msg("权限或进程出错！",{icon:2})}else if(data=="end"){lib.plant(_path,_token)}else{layer.msg(data,{time:0,btn:["确定"]})}}else{$("td").parent().addClass("update-down-progress");$("td").html('<i class="fa fa-download"> 下载中...</i>');lib.down(_path,_token,"put",data)}})}};